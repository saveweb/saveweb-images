name: ko-built saveweb Images

on:
  push:
    branches:
    - 'master'
    paths:
    - '.github/workflows/saveweb-go.yml'
  schedule:
  - cron: "20 * * * *"
  workflow_dispatch:

env:
  REGISTRY_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/saveweb

jobs:
  ko-build-images:
    name: build images with ko-build
    runs-on: ubuntu-24.04
    steps:
      - name: Fetch the latest tag
        shell: bash
        run: |
          set -e
          curl() { $(type -P curl) -LRq --retry 5 --retry-delay 10 --retry-max-time 60 --fail "$@"; }

          cnblogs_repo='git.saveweb.org/saveweb/cnblogs'
          cnblogs_latest_tag=$(curl -L -- "https://${cnblogs_repo%%.git}/tags/list" \
              | jq -r .results[] | sort -Vr | head -n 1)

          huashijie_go_repo='git.saveweb.org/saveweb/huashijie_go'
          huashijie_go_latest_tag=$(curl -L -- "https://${huashijie_go_repo%%.git}/tags/list" \
              | jq -r .results[] | sort -Vr | head -n 1)

          for _var in \
              cnblogs_latest_tag \
              huashijie_go_latest_tag \
              ; do
              if [[ -z "${!_var}" ]]; then
                  echo "FATAL: ${_var} is empty!"
                  exit 1
              fi
              echo "${_var}=${!_var}" >> "$GITHUB_ENV"
          done
          echo "cnblogs_repo=${cnblogs_repo%%.git}"           >> "$GITHUB_ENV"
          echo "huashijie_go_repo=${huashijie_go_repo%%.git}" >> "$GITHUB_ENV"

          curl -o '.ko.yaml' -- \
              https://raw.githubusercontent.com/saveweb/saveweb-images/master/prod.ko.yaml

      - name: Clone the git repos
        shell: bash
        run: |
          set -e
          git_clone() {
              git clone -j "$(nproc)" \
                  --no-tags --shallow-submodules --recurse-submodules --depth 1 --single-branch \
                  "$@";
          }
          clone_with_ref_and_ko_conf() {
              if [ "$#" -ne 2 ]; then
                  echo "Usage: clone_with_ref_and_ko_conf <ref> <git_repo>"
                  return 1
              fi
              local ref="$1"
              local git_repo="$2"

              for _var in ref git_repo; do
                  if [[ -z "${!_var}" ]]; then
                      echo "FATAL: ${_var} is empty!"
                      exit 1
                  fi
              done

              local repo_dir="${git_repo##*/}"
              git_clone "$ref" "$git_repo"
              cp .ko.yaml "./${repo_dir}/"
          }

          set -x
          for project in \
              cnblogs \
              huashijie_go \
              ; do
              # sleep 3s before starting another task
              sleep 3

               tag_varname="${project}_latest_tag"
              repo_varname="${project}_repo"
              clone_with_ref_and_ko_conf \
                  "${!tag_varname}" \
                  "https://${!repo_varname}.git" &
          done
          wait

      - uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          check-latest: true

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: ko-build/setup-ko@v0.7
        env:
          KO_DOCKER_REPO: docker.io/${{ env.REGISTRY_IMAGE }}
        with:
          version: tip

      - name: Build the container images
        shell: bash
        run: |
          set -e
          ko-build() {
              # check whether the script is executed inside a git repo
              if [[ "$(git rev-parse --is-inside-work-tree)" != 'true' ]]; then
                  echo "FATAL: this script MUST be executed inside a git repo."
                  exit 1
              fi

              if [ "$#" -ne 2 ]; then
                  echo "Usage: ko-build <project> <cmd_dir>"
                  return 1
              fi
              local project="$1"
              local cmd_dir="$2"
              for _var in project cmd_dir; do
                  if [[ -z "${!_var}" ]]; then
                      echo "FATAL: ${_var} is empty!"
                      exit 1
                  fi
              done

              ko build "${cmd_dir}/..." --platform=linux/amd64,linux/arm64 --bare --tags "${project}"
              rm -f ./.ko.yaml
              ko build "${cmd_dir}/..." --platform=linux/amd64,linux/arm64 --bare --tags "${project}-debug" --debug
          }

          set -x
          for project in \
              cnblogs \
              huashijie_go \
              ; do
              # sleep 3s before starting another task
              sleep 3

              repo_varname="${project}_repo"
              repo_dir="${!repo_varname##*/}"
              (
                  cd "./${repo_dir}/" || exit 1
                  ko-build \
                      './cmd/' \
                      "${project}" &
              )
          done
          wait
